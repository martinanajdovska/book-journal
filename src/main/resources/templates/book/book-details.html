<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
<div class="container">
    <div class="row" th:if="${hasError}">
        <div class="col-12 justify-content-center my-5 alert alert-danger" role="alert">
            <p th:text="${error}"></p>
        </div>
    </div>
    <div class="row">
        <a type="button" style="width: 150px;" class="btn btn-primary mt-5" href="/">Back</a>
    </div>
    <div class="row my-5 border p-4 align-items-center">
        <div class="col-6 d-flex justify-content-center">
            <img style="max-width: 30rem; max-height: 25rem;" th:src="@{'/uploads/'+${book.getFile()}}" alt="Image for book">
        </div>
        <div class="col-6">
            <h3 th:text="${book.getTitle()}"></h3>
            <h2 th:text="${book.getAuthor()}"></h2>
            <p th:text="'Pages: ' + ${book.getPages()}"></p>
            <p th:text="${book.getGenre().getDisplayValue()}"></p>
            <p th:text="'Average rating: ' + (${averageRating != null ? averageRating : 'No ratings yet.'})"></p>
            <form method="post" th:action="@{'/books/state/{id}' (id=${book.getId()})}">
                <select name="state" id="state" onchange="this.form.submit()">
                    <option selected>Select</option>
                    <option th:selected="${toReadBook}" th:value="toRead">To-read</option>
                    <option th:selected="${userReadBook != null && !toReadBook}" th:value="hasRead">Read</option>
                    <option th:selected="${isCurrentlyReadingBook}" th:value="isCurrentlyReading">Currently reading
                    </option>
                    <option th:value="remove">Remove book</option>
                </select>
            </form>
            <!--            TODO: make form for inputting starting date and reading progress when isCurrentlyReading-->
            <th:block th:if="${userReadBook != null}">
                <form method="post" th:action="'/read-books/add/'+${book.getId()}">
                    <div class="form-group">
                        <label for="startedDate">Started date:</label>
                        <input type="date"
                               style="width:150px;"
                               class="form-control"
                               id="startedDate"
                               name="startedDate"
                               th:value="(${userReadBook.getStartedDate()} != null ? ${userReadBook.getStartedDate()} : null)"
                               placeholder="startedDate">
                        <label for="finishedDate">Finished date:</label>
                        <input type="date"
                               style="width:150px;"
                               class="form-control"
                               id="finishedDate"
                               name="finishedDate"
                               th:value="(${userReadBook.getFinishedDate()} != null ? ${userReadBook.getFinishedDate()} : null)"
                               placeholder="finishedDate">
                    </div>
                    <input type="submit" class="btn btn-primary" value="Add dates">
                </form>
            </th:block>

            <p class="mt-3 mb-0">Summary:</p>
            <p th:text="${book.getDescription()}"></p>
        </div>
    </div>
        <div class="row border p-3">
            <th:block th:if="${userReadBook != null}">
            <form method="post" th:action="'/reviews/add/'+${book.getId()}" class="col-6 pr-4">
                <div class="row">
                    <label for="review">Review:</label>
                    <textarea class="form-control" name="review" id="review" rows="3" placeholder="Add review"></textarea>
                </div>
                <div class="row align-items-center">
                    <div class="form-group mt-2 col-6 pl-0" style="width: 80px;">
                        <label for="rating">Rating:</label>
                        <select name="rating" class="form-control" id="rating" style="width: 70px;">
                            <option value="" selected></option>
                            <option th:each="ratingOpt : ${ratings}"
                                    th:value="${ratingOpt}" th:text="${ratingOpt}"></option>
                        </select>
                    </div>
                    <div class="col-6">
                        <input type="submit" class="btn btn-primary" value="Submit review">
                    </div>
                </div>
            </form>
            </th:block>
            <th:block th:if="${isCurrentlyReadingBook}">
            <form method="post" th:action="'/quotes/add/'+${book.getId()}" class="col-6 pl-3" enctype="multipart/form-data">
                <div class="row">
                    <label for="quote">Quote:</label>
                    <textarea class="form-control" name="quote" id="quote" rows="3" placeholder="Add quote"></textarea>
                </div>
                <div class="row align-items-center">
                    <div class="form-group mt-2 col-6 pl-0">
                        <label for="file">Or add image of text to be scanned.</label>
                        <input type="file" name="file" accept="image/*" id="file">
                    </div>
                    <div class="col-6">
                        <input type="submit" class="btn btn-primary" value="Submit quote">
                    </div>
                </div>
            </form>
            </th:block>
        </div>
    <div class="row mt-5">
        <h3 class="col-12 mb-3">My saved quotes:</h3>
        <th:block th:if="${quotes.size() > 0}">
            <div th:each="quote : ${quotes}" class="col-12 border p-4 m-1">
                <p style="white-space: pre-wrap; overflow-wrap: break-word" th:text="${quote.getText()}"></p>
                <p class="m-0">
                    <a class="btn btn-sm btn-danger" th:href="@{'/quotes/remove/{id}?redirect=/books/details/{bookId}'
                        (id=${quote.getId()}, bookId=${book.getId()})}">Delete</a>
                    <a class="btn btn-sm btn-info" th:href="@{'/quotes/edit/{id}' (id=${quote.getId()})}">Edit</a>
                </p>
            </div>
        </th:block>
    </div>
    <div class="row mt-5">
        <h3 class="col-12 mb-3">Book reviews:</h3>
        <th:block th:if="${reviews.size() > 0}">
            <div th:each="review : ${reviews}" class="col-3 border p-2 m-1 mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <b class="mb-0" th:text="${review.getUser().getUsername()}"></b>
                    <div th:if="${review.getRating()!=null}" class="d-flex justify-content-end align-items-center">
                        <img src="/images/star.png" alt="Star img" width="30px;" height="30px;">
                        <p th:text="${review.getRating()}" class="m-0 mx-1"></p>
                    </div>
                </div>
                <div th:if="${!review.getReview().isBlank()}">
                    <hr>
                    <p th:text="${review.getReview()}"></p>
                </div>
            </div>
        </th:block>
    </div>
</div>
</body>
</html>